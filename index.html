<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ParcelApp - Рейси та Посилки</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 480px;
    margin: 10px auto;
    padding: 0 10px;
    background: #f5f8fa;
    color: #333;
  }
  h1, h2 {
    text-align: center;
    color: #007bff;
  }
  form {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.1);
  }
  label {
    display: block;
    margin-top: 10px;
    font-weight: 600;
  }
  input, select, textarea {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    border-radius: 4px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  button {
    margin-top: 15px;
    padding: 12px;
    width: 100%;
    border: none;
    background: #007bff;
    color: white;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
  }
  button:hover {
    background: #0056b3;
  }
  .section {
    margin-bottom: 30px;
  }
  .list-container {
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.1);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 6px 8px;
    text-align: left;
  }
  th {
    background: #007bff;
    color: white;
  }
  .small-input {
    width: 80px;
    display: inline-block;
  }
</style>
</head>
<body>

<h1>ParcelApp</h1>

<div class="section">
  <h2>Створити Рейс</h2>
  <form id="formCreateRoute">
    <label for="routeName">Назва рейсу *</label>
    <input id="routeName" type="text" required placeholder="Наприклад: Рейс 1" autocomplete="off" />
    <button type="submit">Додати Рейс</button>
  </form>
</div>

<div class="section">
  <h2>Додати Посилку</h2>
  <form id="formAddParcel">
    <label for="selectRoute">Виберіть Рейс *</label>
    <select id="selectRoute" required>
      <option value="">--- оберіть рейс ---</option>
    </select>

    <label for="parcelNumber">Номер посилки *</label>
    <input id="parcelNumber" type="text" required autocomplete="off" />

    <label for="weight">Вага (кг) *</label>
    <input id="weight" type="number" step="0.01" min="0" required />

    <label for="placesCount">Кількість місць *</label>
    <input id="placesCount" type="number" min="1" required />

    <div id="volumeWeightsContainer"></div>

    <label for="city">Місто *</label>
    <input id="city" type="text" required autocomplete="off" />

    <label for="npBranch">Відділення Нової Пошти *</label>
    <input id="npBranch" type="text" required autocomplete="off" />

    <label for="receiver">Отримувач *</label>
    <input id="receiver" type="text" required autocomplete="off" />

    <label for="receiverPhone">Телефон *</label>
    <input id="receiverPhone" type="tel" required autocomplete="off" />

    <label for="priceEuro">Вартість (€) *</label>
    <input id="priceEuro" type="number" step="0.01" min="0" required />

    <label for="description">Опис</label>
    <textarea id="description" rows="2" placeholder="Додаткові деталі"></textarea>

    <button type="submit">Додати Посилку</button>
  </form>
</div>

<div class="section">
  <h2>Рейси та Посилки</h2>
  <div id="routesList" class="list-container">
    <p>Завантаження рейсів і посилок...</p>
  </div>
</div>

<script type="module">
// Firebase SDK імпорти
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

// Конфіг Firebase — встав сюди свій
const firebaseConfig = {
  apiKey: "AIzaSyBjLuotxHzCIkSLduDlLb3AYTc6A6A8NYc",
  authDomain: "parcelapp-900b9.firebaseapp.com",
  projectId: "parcelapp-900b9",
  storageBucket: "parcelapp-900b9.firebasestorage.app",
  messagingSenderId: "310089427450",
  appId: "1:310089427450:web:a3b6dcd22aee438028dc43",
  measurementId: "G-LD8DF4V543"
};

// Ініціалізація Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Елементи
const formCreateRoute = document.getElementById('formCreateRoute');
const formAddParcel = document.getElementById('formAddParcel');
const selectRoute = document.getElementById('selectRoute');
const volumeWeightsContainer = document.getElementById('volumeWeightsContainer');
const routesList = document.getElementById('routesList');

let currentRoutes = []; // збережені рейси (масив обʼєктів)
let currentParcels = []; // посилки (масив обʼєктів)

// --- Динамічне створення полів обʼємної ваги ---
const placesCountInput = document.getElementById('placesCount');
placesCountInput.addEventListener('input', () => {
  const count = parseInt(placesCountInput.value) || 0;
  volumeWeightsContainer.innerHTML = '';
  if (count > 0) {
    for (let i = 0; i < count; i++) {
      const label = document.createElement('label');
      label.textContent = `Обʼємна вага місця #${i + 1} (кг) *`;
      const input = document.createElement('input');
      input.type = 'number';
      input.step = '0.01';
      input.min = '0';
      input.required = true;
      input.name = 'volumeWeight';
      volumeWeightsContainer.appendChild(label);
      volumeWeightsContainer.appendChild(input);
    }
  }
});

// --- Функція для оновлення списку рейсів у select ---
function updateRouteOptions() {
  selectRoute.innerHTML = '<option value="">--- оберіть рейс ---</option>';
  currentRoutes.forEach(route => {
    const opt = document.createElement('option');
    opt.value = route.id;
    opt.textContent = route.name;
    selectRoute.appendChild(opt);
  });
}

// --- Функція для відображення рейсів та посилок ---
function renderRoutesAndParcels() {
  if (currentRoutes.length === 0) {
    routesList.innerHTML = '<p>Рейсів поки немає.</p>';
    return;
  }
  let html = '';
  currentRoutes.forEach(route => {
    html += `<h3>${route.name}</h3>`;
    const parcelsForRoute = currentParcels.filter(p => p.routeId === route.id);
    if (parcelsForRoute.length === 0) {
      html += '<p>Посилок немає.</p>';
    } else {
      html += `<table><thead><tr>
        <th>№ посилки</th><th>Вага (кг)</th><th>Місць</th><th>Обʼємна вага</th><th>Місто</th><th>Відділення НП</th><th>Отримувач</th><th>Телефон</th><th>Ціна (€)</th><th>Опис</th>
      </tr></thead><tbody>`;
      parcelsForRoute.forEach(p => {
        html += `<tr>
          <td>${p.number}</td>
          <td>${p.weight.toFixed(2)}</td>
          <td>${p.placesCount}</td>
          <td>${p.volumeWeights.map(w => w.toFixed(2)).join(', ')}</td>
          <td>${p.city}</td>
          <td>${p.npBranch}</td>
          <td>${p.receiver}</td>
          <td>${p.receiverPhone}</td>
          <td>${p.priceEuro.toFixed(2)}</td>
          <td>${p.description || ''}</td>
        </tr>`;
      });
      html += '</tbody></table>';
    }
  });
  routesList.innerHTML = html;
}

// --- Завантаження рейсів ---
async function loadRoutes() {
  const routesCol = collection(db, 'routes');
  const snapshot = await getDocs(routesCol);
  currentRoutes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  updateRouteOptions();
  renderRoutesAndParcels();
}

// --- Завантаження посилок ---
async function loadParcels() {
  const parcelsCol = collection(db, 'parcels');
  const snapshot = await getDocs(parcelsCol);
  currentParcels = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  renderRoutesAndParcels();
}

// --- Створення нового рейсу ---
formCreateRoute.addEventListener('submit', async e => {
  e.preventDefault();
  const routeName = document.getElementById('routeName').value.trim();
  if (!routeName) return alert('Введіть назву рейсу');
  try {
    const routesCol = collection(db, 'routes');
    await addDoc(routesCol, { name: routeName, createdAt: new Date().toISOString() });
    document.getElementById('routeName').value = '';
    await loadRoutes();
  } catch(err) {
    alert('Помилка при створенні рейсу: ' + err.message);
  }
});

// --- Додавання посилки ---
formAddParcel.addEventListener('submit', async e => {
  e.preventDefault();

  const routeId = selectRoute.value;
  if (!routeId) return alert('Оберіть рейс');

  const number = document.getElementById('parcelNumber').value.trim();
  const weight = parseFloat(document.getElementById('weight').value);
  const placesCount = parseInt(document.getElementById('placesCount').value);
  const city = document.getElementById('city').value.trim();
  const npBranch = document.getElementById('npBranch').value.trim();
  const receiver = document.getElementById('receiver').value.trim();
  const receiverPhone = document.getElementById('receiverPhone').value.trim();
  const priceEuro = parseFloat(document.getElementById('priceEuro').value);
  const description = document.getElementById('description').value.trim();

  // Обʼємна вага
  const volumeInputs = document.getElementsByName('volumeWeight');
  const volumeWeights = Array.from(volumeInputs).map(input => parseFloat(input.value));

  if (volumeWeights.length !== placesCount || volumeWeights.some(isNaN)) {
    return alert('Заповніть усі поля обʼємної ваги');
  }
  if (!number || !weight || !placesCount || !city || !npBranch || !receiver || !receiverPhone || isNaN(priceEuro)) {
    return alert('Будь ласка, заповніть всі обовʼязкові поля');
  }

  try {
    const parcelsCol = collection(db, 'parcels');
    await addDoc(parcelsCol, {
      routeId,
      number,
      weight,
      placesCount,
      volumeWeights,
      city,
      npBranch,
      receiver,
      receiverPhone,
      priceEuro,
      description,
      createdAt: new Date().toISOString()
    });
    alert('Посилка додана!');
    formAddParcel.reset();
    volumeWeightsContainer.innerHTML = '';
  } catch(err) {
    alert('Помилка при додаванні посилки: ' + err.message);
  }

  await loadParcels();
});

// Ініціалізація: завантажуємо дані при запуску
loadRoutes();
loadParcels();

</script>

</body>
</html>