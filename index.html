<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Рейси та посилки</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 480px;
    margin: 0 auto;
    padding: 10px;
    background: #f5f5f7;
    color: #222;
  }
  h1, h2 {
    text-align: center;
  }
  label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
  }
  input, textarea, select, button {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    font-size: 1rem;
  }
  button {
    background: #007bff;
    color: white;
    border: none;
    margin-top: 15px;
    cursor: pointer;
  }
  button:hover {
    background: #0056b3;
  }
  .secondary-btn {
    background: #28a745;
  }
  .secondary-btn:hover {
    background: #1e7e34;
  }
  .section {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
  }
  .volume-weights-container label {
    font-weight: normal;
    margin-top: 8px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 6px;
    font-size: 0.9rem;
    text-align: left;
  }
  th {
    background: #007bff;
    color: white;
  }
  .actions button {
    margin-right: 5px;
    padding: 4px 8px;
    font-size: 0.85rem;
    border-radius: 4px;
  }
  .actions button.delete {
    background: #dc3545;
    border: none;
    color: white;
  }
  @media (max-width: 400px) {
    input, textarea, select, button {
      font-size: 0.9rem;
    }
    th, td {
      font-size: 0.8rem;
    }
  }
</style>
</head>
<body>

<h1>Рейси та посилки</h1>

<div class="section" id="tripSection">
  <h2>Створити / Вибрати рейс</h2>
  <form id="tripForm">
    <label for="tripName">Назва рейсу *</label>
    <input type="text" id="tripName" required placeholder="Наприклад: Рейс 01" autocomplete="off" />
    <button type="submit">Додати / Обрати рейс</button>
  </form>
  <div style="margin-top:10px;">
    <strong>Список рейсів:</strong>
    <select id="tripSelect" style="margin-top:5px;"></select>
  </div>
</div>

<div class="section" id="parcelSection" style="display:none;">
  <h2>Додати посилку до рейсу: <span id="currentTripName"></span></h2>
  <form id="parcelForm">
    <label for="parcelNumber">№ посилки *</label>
    <input type="text" id="parcelNumber" required autocomplete="off" />

    <label for="weight">Вага (кг) *</label>
    <input type="number" id="weight" step="0.01" min="0" required />

    <label for="placesCount">Кількість місць *</label>
    <input type="number" id="placesCount" min="1" value="1" required />

    <div class="volume-weights-container" id="volumeWeightsContainer"></div>

    <label for="receiver">Отримувач *</label>
    <input type="text" id="receiver" required autocomplete="off" />

    <label for="city">Місто *</label>
    <input type="text" id="city" required autocomplete="off" />

    <label for="npBranch">Відділення Нової Пошти *</label>
    <input type="text" id="npBranch" required autocomplete="off" />

    <label for="receiverPhone">Телефон *</label>
    <input type="text" id="receiverPhone" required autocomplete="off" />

    <label for="priceEuro">Ціна (€) *</label>
    <input type="number" id="priceEuro" step="0.01" min="0" required />

    <label for="description">Опис</label>
    <textarea id="description" rows="2"></textarea>

    <button type="submit">Додати посилку</button>
  </form>

  <h3>Посилки рейсу</h3>
  <table id="parcelTable" aria-label="Список посилок рейсу">
    <thead>
      <tr>
        <th>№</th>
        <th>Вага (кг)</th>
        <th>Місць</th>
        <th>Обʼємна вага (кг)</th>
        <th>Отримувач</th>
        <th>Місто</th>
        <th>Відділення НП</th>
        <th>Телефон</th>
        <th>Ціна (€)</th>
        <th>Опис</th>
        <th>Дії</th>
      </tr>
    </thead>
    <tbody id="parcelListBody"></tbody>
  </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where,
    deleteDoc,
    doc,
    orderBy
  } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBjLuotxHzCIkSLduDlLb3AYTc6A6A8NYc",
    authDomain: "parcelapp-900b9.firebaseapp.com",
    projectId: "parcelapp-900b9",
    storageBucket: "parcelapp-900b9.firebasestorage.app",
    messagingSenderId: "310089427450",
    appId: "1:310089427450:web:302617ae37a9ac6528dc43",
    measurementId: "G-Q6HK04XH7Y"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const tripForm = document.getElementById('tripForm');
  const tripSelect = document.getElementById('tripSelect');
  const parcelSection = document.getElementById('parcelSection');
  const currentTripNameSpan = document.getElementById('currentTripName');
  const parcelForm = document.getElementById('parcelForm');
  const placesCountInput = document.getElementById('placesCount');
  const volumeWeightsContainer = document.getElementById('volumeWeightsContainer');
  const parcelListBody = document.getElementById('parcelListBody');

  let currentTrip = null;
  let parcels = [];

  // Рендер динамічних полів обʼємної ваги
  function renderVolumeWeightInputs(count, values = []) {
    volumeWeightsContainer.innerHTML = '';
    for (let i = 0; i < count; i++) {
      const label = document.createElement('label');
      label.textContent = `Обʼємна вага місця #${i + 1} (кг) *`;
      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.step = '0.01';
      input.required = true;
      input.value = values[i] ?? '';
      input.name = 'volumeWeight';
      volumeWeightsContainer.appendChild(label);
      volumeWeightsContainer.appendChild(input);
    }
  }

  placesCountInput.addEventListener('input', () => {
    const count = parseInt(placesCountInput.value) || 1;
    renderVolumeWeightInputs(count);
  });

  renderVolumeWeightInputs(1);

  // Додавання/вибір рейсу
  tripForm.addEventListener('submit', async e => {
    e.preventDefault();
    const name = document.getElementById('tripName').value.trim();
    if (!name) {
      alert('Введіть назву рейсу');
      return;
    }

    try {
      const tripsCol = collection(db, 'trips');
      const q = query(tripsCol, where('name', '==', name));
      const querySnapshot = await getDocs(q);

      if (querySnapshot.empty) {
        const docRef = await addDoc(tripsCol, { name, createdAt: new Date().toISOString() });
        currentTrip = { id: docRef.id, name };
      } else {
        const docSnap = querySnapshot.docs[0];
        currentTrip = { id: docSnap.id, name: docSnap.data().name };
      }
      updateUIAfterTripSelect();
      loadParcels();
      await loadTrips(); // оновити список
    } catch (error) {
      alert('Помилка при додаванні/виборі рейсу: ' + error.message);
    }
  });

  // Оновлення UI після вибору рейсу
  function updateUIAfterTripSelect() {
    currentTripNameSpan.textContent = currentTrip.name;
    parcelSection.style.display = 'block';
    tripSelect.value = currentTrip.id;
  }

  // Завантаження рейсів у селект
  async function loadTrips() {
    const tripsCol = collection(db, 'trips');
    const q = query(tripsCol, orderBy('createdAt', 'desc'));
    const querySnapshot = await getDocs(q);
    tripSelect.innerHTML = '';
    querySnapshot.forEach(docSnap => {
      const option = document.createElement('option');
      option.value = docSnap.id;
      option.textContent = docSnap.data().name;
      tripSelect.appendChild(option);
    });
    if (!currentTrip && querySnapshot.docs.length > 0) {
      const firstTrip = querySnapshot.docs[0];
      currentTrip = { id: firstTrip.id, name: firstTrip.data().name };
      updateUIAfterTripSelect();
      loadParcels();
    }
  }

  tripSelect.addEventListener('change', () => {
    const selectedId = tripSelect.value;
    if (!selectedId) return;
    currentTrip = { id: selectedId, name: tripSelect.options[tripSelect.selectedIndex].text };
    updateUIAfterTripSelect();
    loadParcels();
  });

  // Завантаження посилок для поточного рейсу
  async function loadParcels() {
    if (!currentTrip) return;
    const parcelsCol = collection(db, 'parcels');
    const q = query(parcelsCol, where('tripId', '==', currentTrip.id));
    const querySnapshot = await getDocs(q);
    parcels = [];
    querySnapshot.forEach(docSnap => {
      parcels.push({ id: docSnap.id, ...docSnap.data() });
    });
    renderParcels();
  }

  // Рендер посилок в таблицю
  function renderParcels() {
    parcelListBody.innerHTML = '';
    if (parcels.length === 0) {
      parcelListBody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:10px;">Посилок немає</td></tr>`;
      return;
    }
    parcels.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.number}</td>
        <td>${p.weight.toFixed(2)}</td>
        <td>${p.placesCount}</td>
        <td>${p.volumeWeights.map(w => w.toFixed(2)).join(', ')}</td>
        <td>${p.receiver}</td>
        <td>${p.city}</td>
        <td>${p.npBranch}</td>
        <td>${p.receiverPhone}</td>
        <td>${p.priceEuro.toFixed(2)}</td>
        <td>${p.description || ''}</td>
        <td class="actions">
          <button class="delete" data-id="${p.id}">Видалити</button>
        </td>
      `;
      parcelListBody.appendChild(tr);
    });
  }

  // Додавання посилки
  parcelForm.addEventListener('submit', async e => {
    e.preventDefault();
    if (!currentTrip) {
      alert('Оберіть рейс');
      return;
    }

    const number = document.getElementById('parcelNumber').value.trim();
    const weight = parseFloat(document.getElementById('weight').value);
    const placesCount = parseInt(document.getElementById('placesCount').value);
    const volumeWeightsInputs = volumeWeightsContainer.querySelectorAll('input[name="volumeWeight"]');
    const volumeWeights = Array.from(volumeWeightsInputs).map(i => parseFloat(i.value));
    const receiver = document.getElementById('receiver').value.trim();
    const city = document.getElementById('city').value.trim();
    const npBranch = document.getElementById('npBranch').value.trim();
    const receiverPhone = document.getElementById('receiverPhone').value.trim();
    const priceEuro = parseFloat(document.getElementById('priceEuro').value);
    const description =